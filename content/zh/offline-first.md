---
title: "离线在前"
category: "移动设备"
menu_order: 30
tags:
  - "离线的"
  - "原生的"
  - "移动网络"
  - "studio pro"
---

## 1 导言

为了提供连续体验，离线第一个应用程序不论是否有连接。 页面和逻辑与设备上的离线数据库交互，数据与服务器同步。 这将产生一个快照界面、提高可靠性和改善设备电池使用寿命。

{{% alert type="info" %}}
必须认识到，离线首先是一种建筑概念，而不是一种基于设备网络状态的方法。 离线第一个应用不依赖于连接，但可以使用连接 (例如) 您可以调用 microflow，使用谷歌地图小部件或使用推送通知)。
{{% /报警 %}}

Mendix 支持为 [本机移动](native-mobile) 和 [混合移动应用程序](hybrid-mobile) 应用程序构建离线第一个应用程序。 本机应用和混合应用拥有相同的核心，这使它们具有相同的离线第一功能。 本机移动应用总是离线的，但是对于混合移动应用，它取决于已配置的导航配置文件。 数据存储在设备上的本地数据库中，文件存储在设备的文件存储中。

Mendix Studio Pro 进行验证以确保您的应用遵循离线第一种方法，即使没有连接，也能正常工作。

在发展过程中， [使它成为本机移动手机应用程序](https://play.google.com/store/apps/details?id=com.mendix.developerapp) (针对本机移动应用程序) 或 [Mendix 移动应用程序](https://play.google.com/store/apps/details?id=com.mendix.SprintrMobile) (针对混合移动应用程序) 可以用于预览和测试您的 Mendix 应用在设备上。 第一次加载您的 Mendix 应用程序， 需要互联网连接才能在服务器上创建会话并下载必要的数据和资源。 初始同步后，即使没有互联网连接，数据仍然可以在应用中使用。 随后的同步将在用户请求时通过应用逻辑或在模型更改后进行。

## 2 次同步{#synchronization}

Mendix 自动分析您的应用数据模型，以确定哪些实体应该根据您离线导航配置中使用的页面和nanoflows同步. 此外，平台还考虑到实体访问，以便只有用户被允许访问的数据能够同步。

在以下场景中自动触发同步：

* 您的手机应用的初始启动
* 在您的 Mendix 应用程序被重新部署后，您的手机应用首次启动，当以下条件匹配时：
 * 有网络连接
 * 您正在使用新的 Mendix 版本或离线第一个应用程序中使用的域模型已更改
* 在应用程序登录或退出后的用户

同步也可以通过您的 Mendix 应用程序的不同位置进行配置，例如：

* 作为按钮上的操作
* 作为纳米处理的操作
* 作为列表视图上的下拉动作 (仅供本地移动)

在数据库一级进行同步操作。 这意味着如果您在对对象有一些未承诺的更改时同步， 本地数据库中的属性值将被同步，忽略未承诺的更改。 同步后未提交的更改仍可用。

### 2.1 同步类型

您可以在两个级别执行同步：
* [完全同步](#full-sync)
* [选择同步](#selective-sync)

#### 2.1.1 完全同步 {#full-sync}

此模式对离线第一个应用中使用的所有实体同时执行上传和下载阶段。 您可以定制每个实体的 [自定义同步](#customizable-synchronization)。

#### 2.1.2 选择性同步 {#selective-sync}

此模式允许您选择要同步的特定对象。

选择性同步只能通过 **在 nanoflow 中同步** 动作。 使用UI元素进行同步(例如按钮、转义动动作或其他元素) 执行完全同步。

### 2.2 同步阶段

这个同步过程包括两个阶段。 在 [上传阶段](#upload)，您的应用更新了服务器数据库中的新的或更改了提交的对象。 在 [下载阶段](#download)，您的应用使用服务器数据库中的数据更新了本地数据库。

#### 2.2.1 上传阶段 {#upload}

上传阶段开始时对应提交给服务器的新对象或更改对象进行引用完整性验证。 这个验证检查每个待提交对象对其他对象的引用。 如果此验证失败，同步将中止并显示错误消息(如果错误未被抓取)。

在 [完全同步](#full-sync) 期间，此验证确保所有被引用的对象都被承诺到本地数据库。 如果一个引用的对象是在设备上创建的并且尚未承诺到本地数据库， 同步被中止，以防止服务器数据库中的引用值无效。 请注意同步只能在数据库一级正常工作。

例如，当一个承诺的 `City` 对象提到一个未承诺的 `国家` 对象， 同步 `城市` 对象会产生无效的 `国家` 对象参考 这将破坏应用的数据完整性。 如果当数据完整性损坏时触发同步， 下面的错误信息将会显示(在模型中显示一个错误到修正): "同步由于一个建模错误而失败。 您的数据库包含未提交的对象：类型 `City` 的对象(参考 `City_Country`)。" 为了解决这个问题，在同步之前必须先提交这些对象(在这个示例中， `乡村`应该在同步之前提交)。

在 [期间选择同步](#selective-sync)， 一个额外的引用完整性验证是为了确保所有被引用的对象至少同步到服务器数据库或包含在选择中。

例如， 只同步一个已承诺的 `城市` 对象引用离线 `国家` 对象(在设备上创建并致力于本地数据库，但尚未同步) 会破坏服务器数据库中的 `城市` 对象的完整性，因为 `国家` 对象没有存储在服务器数据库中。 在这种情况下，将会出现类似的错误消息，表明它是一个建模错误。 要解决这个问题，必须选择此对象进行同步。 在这个示例中， `国家/地区` 应该在尝试同步 `City` 对象之前选择同步或同步。

上传阶段在验证后执行以下操作：

1. 只能通过提交对象来修改本地数据库。 这个对象可以是一个新的对象(在离线时)，或者它可以是一个以前从服务器同步过来的现有对象。 上传阶段检测到自上次同步以来有哪些对象被承诺到本地数据库。 每个同步类型的检测不同。 为了 **同步所有**，所有在本地数据库中承诺的对象都被选中。 对于 **同步对象**，所有从选定对象列表中提交的对象都被选中。
2. <a name="steptwo"></a>如果更改或新的文件对象，它们的内容会上传到服务器并临时存储。 每个文件上传到一个单独的网络请求。
3. <a name="stepthree"></a>所有更改的对象和新对象都被承诺到服务器上，文件的内容被链接到对象。 此步骤是在单个网络请求中执行的。 在这些对象上配置的任何事前或事后事件处理程序都会像往常一样在服务器上运行， 数据已上传并下载之前。

#### 2.2.2 下载阶段 {#download}

如果上传阶段成功，下载阶段将开始，在这个阶段中使用服务器数据库的最新数据更新本地数据库。 下载阶段的行为因同步类型而异。

**完全同步** - 向每个实体的服务器发出网络请求，以便从服务器数据库中检索最新数据。 您可以通过自定义应用的同步行为来管理哪些实体与本地数据库同步。 关于此程序的更多详细信息，请参阅下面 [个性化同步](#customizable-synchronization) 部分。 下载过程也会下载文件实体的内容并保存到您的设备存储。 这一进程是渐进性的。 如果文件之前没有下载，应用只能下载文件对象的内容。 或者该文件自上次下载以来已被更改。 文件实体更改的日期属性用于确定文件对象的内容是否已更改。

**选择性同步** — 只有选择同步的对象才会同步到本地数据库。 没有额外的网络请求来检索这些对象。 在上传阶段的网络请求中返回对象。 如果选择要同步的文件实体，其内容也会在设备存储上逐步更新。 逻辑与完全同步相同。

### 2.3 同步后

同步完成后，您应用当前页面上的小部件将被刷新，以反映最新数据。 如果从 nanoflow 触发同步，则更新所有 nanoflow 对象/列表变量(未承诺的更改仍然保留)。

请注意，如果对象在同步期间从设备中删除，则nanoflow 对象变量值可能在同步后为 `空`。 在下列情况下可能会发生这种情况：

* 此对象在服务器上被删除
* 当前用户对对象没有足够的访问权(由安全访问规则定义)
* 在 [自定义同步](#customizable-synchronization) 屏幕上配置了XPath 约束，对象不再符合指定的 XPath 约束
* 该实体在可自定义的同步屏幕上配置 **没有 (清除数据)** 选项
* 对象的上传阶段失败， 例如，在提交事件处理程序返回虚假或提交失败时，因为违反了独特的验证

### 2.4 可自定义同步 {#customizable-synchronization}

{{% alert type="warning" %}}
这些设置不适用于 [有选择的同步](#selective-sync)。
{{% /报警 %}}

默认情况下，Mendix 会自动决定哪些对象需要同步在 [同步](#synchronization) 中提到。

视使用情况而定，可能需要更严格的同步控制。 因此，可以改变一个实体的下载行为。 您可以在以下选项中选择：

* **所有对象** — 下载所有适用正常安全约束的对象
* **通过 XPath** — 仅下载匹配 [XPath 约束的对象](xpath-constraints) 以及常规安全限制。 这意味着所有以前同步的对象不匹配 XPath 约束将被删除。
* **没有 (清除数据)** — — 不自动下载任何对象， 但在执行同步时清除数据库中存储给该实体的数据(这可能对对象只能上传的情况下有用) 例如a `反馈` 实体)
* **Nothing (preserve data)** — do not download any objects automatically, and do not clear the data stored in the database for this entity when performing a synchronization  (this can be useful in cases where you want have full control over the synchronization and should be used in combination with the [Synchronize to device](synchronize-to-device) or [Synchronize](synchronize) activity with specific objects selected)

如果您有自定义小部件或 JavaScript 动作使用Studio Pro 在您的离线第一个配置文件中无法检测到的实体(因为它仅用于代码中)， 您可以使用可自定义的同步来包含这些实体。

{{% image_container width="450" %}}![custom synchronization](attachments/offline-first/custom-sync.png){{% /image_container %}}

### 2.5 限制

不支持同时运行多个同步进程，不管类型是(**完整** 或 **选择**)。 欲了解更多信息，请参阅 *同步参考指南* 的 [限制](synchronize#limitations) 部分。

### 2.6 错误处理 {#error-handling}

在同步期间，可能出现错误。 本节描述Mendix 如何处理这些错误以及如何防止它们。

#### 2.6.1 与网络有关的错误 {#network-errors}

同步需要连接到服务器，所以在同步过程中，可能会由于网络连接失败或差而发生错误。 网络错误可能涉及丢弃连接或超时。 默认情况下，混合移动应用每个网络请求30秒的同步超时。 对于本机应用，没有默认超时，超时由平台和操作系统版本决定。

同步为原子，这意味着要么是同步，要么是同步，要么是没有同步的。 下面 [模型或数据相关错误](#othererrors) 部分描述了例外情况。

如果在文件上传过程中发生网络错误(通过上传阶段的 [第](#steptwo)步) Mendix 重试上传失败的文件。 如果第二次出现错误，同步将被中止。 当时的更改保留在本地设备上，以便以后再试。

如果上传数据时发生网络错误(通过上传阶段的 [第](#stepthree)步) 数据保存在本地设备上，服务器上没有更改。 上传于 [步骤 2](#steptwo) 中的任何文件将在下次同步时再次上传。

如果上传数据后出现网络错误(例如超时) (在上传阶段的 [第](#stepthree)步) 数据保存在本地设备上。 然而，由于服务器已经开始处理请求，因此它将完成请求并提交对服务器数据库的更改。 设备无法区分服务器是否处理了请求，因此下一次同步尝试将包含已应用的更改。 在这种情况下，服务器基于Mendix 版本的行为将有所不同。 在 Mendix Studio Pro v8 中。 8 或更低版本的服务器将再次进行相同的更改，这可能会覆盖其他用户在两次同步之间所作的潜在更改。 从 Studio Pro v8.18 及以上的流程是优化的，服务器将不会提交相同的更改，因为它们以前已经应用。

如果在下载阶段发生网络错误，设备上没有更新数据。 因此，用户可以继续工作或重试。 上传阶段的效果不会回滚到服务器上。

如果从 nanoflow 调用同步，则可以使用 nanoflow 错误处理错误。 在其他情况下(例如，如果同步是从按钮或启动时调用)， 一个消息将显示给用户，数据无法同步。

#### 2.6.2 模型或数据相关错误 {#othererrors}

在同步期间，更改了并提交了新的对象。 由于以下原因，对象的同步可能遇到问题：

* 此对象在服务器上不再可用 (要么删除要么由于访问规则无法访问)
* 由于访问规则，对象的成员已经无法访问
* 执行之前或之后提交的事件微流时发生错误
* 该对象根据域级别验证规则无效

{{% alert type="warning" %}}When a synchronization error occurs because of one the reasons above, an object's commit is skipped, its changes are ignored, and references from other objects to it become invalid. 引用这种跳过对象的对象（不会触发错误）将正常同步。 这种情况可能是一个建模错误，已登录到服务器。 为了防止数据丢失，这些对象的属性值存储在 `System.Synchronization错误` 实体 (从 Mendix 8.12) 中。  {{% /报警 %}}

### 2.6.3 预防同步问题 {#prevent-sync-issues}

为了避免上述问题，我们建议遵循这些最佳做法：

* 不要删除，重命名， 或在您最初发布后更改离线应用中的实体类型或其属性 — 这可能导致离线用户无法再访问对象或值 (如果需要的话) 您可以做一个“中间”版本，它仍然是后向兼容的，然后在所有应用同步后在下一次版本中进行更改)
* 不要删除可以同步到离线用户的对象 (试图同步这些对象时会导致这些对象上的更改丢失)
* 避免对离线实体使用域级验证 — — 使用 nanoflow或输入验证 (它也是使用microflow在服务器上再次验证的良好做法)
* 当提交被其他对象引用的对象时，请确保其他对象也被执行

如果在nanoflow 中触发同步动作并发生错误， 它是可以使用nanoflow错误处理错误的。

### 2.6.4 解决冲突 {#conflict-res}

可能会发生多个用户在其设备上同步对象的相同状态， 更改，然后将此对象同步回到服务器。 在这种情况下，最后一次同步会覆盖服务器上对象的全部内容。 这也被称为“最后获胜”办法。

如果需要采取另一种办法，就可以在事先提交的微流中发现冲突（例如在实体上使用修订版ID属性）。 在此基础上，可以进行自定义冲突解决。

## 3 最佳做法 {#best-practices}

为了确保您的 Mendix 应用程序的最佳用户体验，遵循这些最佳做法：

* 限制将通过自定义同步配置或安全访问规则同步的数据数量
* 由于网络连接可能缓慢且不可靠，移动设备的存储空间也往往很有限。 避免同步大文件或图像(例如，限制照片大小)
* 尝试通过nanoflow 而不是UI 元素同步，以便您可以将错误处理添加到同步活动中，当同步失败时可以处理大小写(连接错误)， 模型和数据错误及更多相关错误)
* 使用选择性同步大文件或图像
* 使用 `未删除` 布尔属性来删除功能，以便能够在服务器上正确地处理冲突
* 使用事前和事后提交的微流来处理前或事后数据。
* 在 nanoflow 中使用 [微流程调用](microflow-call) 来执行额外的服务器端逻辑，例如从REST 服务中检索数据。 或者访问和使用复杂逻辑，例如Java 动作。
* 帮助您的用户记住同步他们的数据，以便它尽快处理：您可以检查连接并自动同步到提交您的对象的 nanoflow 中， 或提醒用户在使用通知时或在签出前同步以确保数据不丢失。

## 4 确保您的应用处于离线前 {#limitations}

Mendix 帮助开发者构建丰富的离线应用程序。 然而，还有一些限制。

### 4.1 微型流动 {#microflows}

微流可以通过使用 [微流调用](microflow-call) 动作来在服务器上执行逻辑，从离线应用调用。 然而，它的运作与在线简介中使用时略有不同，这些差异解释如下：

#### 4.1.1 微流参数类型

* 不支持通过对象或可持久实体列表。
* 不支持通过与可持久实体有联系的不可持续实体的对象或清单（这种联系可以是间接协会）。
* 不支持传递在另一个微流中创建的不可持续实体

#### 4.1.2 UI 操作

UI相关操作将被忽略，将不会产生任何效果。 我们鼓励您模拟这种UI侧的效果，用调用纳诺夫来模拟。

这些行动如下：

* [显示消息](show-message)
* [显示验证消息](validation-feedback)
* [显示主页](show-home-page)
* [显示页面](show-page)
* [关闭页面](close-page)
* [下载文件](download-file)

#### 4.1.3 物体侧面效果

在微流中对可持久对象所作的更改将不会反映在客户端上，除非您同步。 必须返回不可持续对象才能反映变化。

#### 4.1.4 微流返回价值

* 不支持返回对象或可持久实体列表。
* 不支持返回与可持久实体有联系的目标或不可持续实体清单（这种联系可以是间接协会）。

#### 4.1.5 语文切换

要切换Mendix 应用程序的语言，设备必须在线并可以访问 Mendix 运行时间。 关于运行时间的更多信息，请参阅 [运行时间参考指南](runtime)。

### 4.2 离线微流最佳做法 {#offline-mf-best-practices}

要使微流程调用在离线第一应用中，Mendix 会在离线应用中存储一些微流程信息。 该信息来自应用程序。 这意味着离线应用所用微流的更改必须是向后兼容的， 因为尚未通过空气更新收到较旧的应用。 来自此设备的所有微流调用仍将包含旧的 nanoflows 调用配置，这意味着请求可能失败。 关于空气更新的更多信息，请参阅 [如何在空气更新上使用](/howto8/mobile/how-to-ota)。

为了避免首次发布后离线微流呼叫中出现倒退兼容错误，我们建议这些最佳做法：

* 不要重命名微流或将其移动到不同的模块
* 不要重命名包含从离线应用调用的微流的模块
* 不添加、移除、重命名或更改微流参数类型
* 不更改退货类型
* 在确保所有设备都已收到更新之前，不要删除微流

如果你想要偏离上述做法，引入新的微流。 您可以更改微流程的内容， 但牢记旧应用程序可能会调用新版本的微流直到他们被更新。

### 4.3 自动生成器 & 计算的属性 {#autonumbers}

自动卸载器和计算属性都需要从服务器输入；因此，它们是不允许的。 具有这些属性类型的对象仍然可以在离线查看和创建，但属性本身不能显示。

### 4.4 默认属性值 {#default-attributive}

域模型中实体的默认属性值对离线创建的对象没有任何影响。 布尔属性总是默认为 `false`, 数字属性为 `0`, 以及其他属性为 `空`。

### 4.5 多个协会 {#many-to-many}

不支持多对多个关联。 一个共同的备选办法是设立一个与其他实体有一对多个联系的第三个实体。

### 4.6 继承权 {#inheritance}

一般或专门关系中不可能使用一个以上的实体。 例如，如果你有一个 `动物` 实体和 `狗` 专业化， 您可以使用 `动物` 或 `狗`，但不能使用离线配置文件。 另一种模式是使用合成（例如客体协会）。

### 4.7 系统成员 {#system-members}

系统成员`创建日期`, `更改日期`, `所有者`, `更改by`不支持

### 4.8 Excel and CSV Export {#excel-cv}

Excel 和 CSV 导出在离线应用程序中不可用。
