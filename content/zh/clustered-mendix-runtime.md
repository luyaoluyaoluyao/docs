---
title: "集群的 Mendix 运行时间"
category: "Mendix 运行时间"
description: "使用集群功能，您可以设置您的 Mendix 应用程序来运行在负载平衡器后面，以启用失败和/或高可用性架构。"
tags:
  - "运行时间"
  - "群組"
  - "负载平衡器"
  - "失败"
  - "studio pro"
---

{{% alert type="info" %}}
<img src="attachments/chinese-translation/china.png" style="display: inline-block; margin: 0" /> 对于简体中文翻译，请点击 [中文为 xix x](https://cdn.mendix.tencent-cloud.com/documentation/refguide8/refguide8/clustered-mendix-runtime.pdf)。
{{% /报警 %}}

## 1 导言

此页面描述运行 Mendix Runtime 作为集群的行为和影响。 使用集群功能，您可以设置您的 Mendix 应用程序来运行在负载平衡器后面，以启用失败和/或高可用性架构。

集群的主要功能是Mendix无国籍的运行时架构。 这意味着肮脏状态(不可持续实体实例和尚未保存的更改)存储在客户端上，而不是存储在服务器上。 这使Mendix Runtime更容易缩放，因为每个群集节点都可以处理客户端的任何请求。 无国籍的运行时架构也能够更好地进行肮脏状态的维护和更好地了解应用程序状态。

## 2 个集群支持

集群支持是本来就在我们的Cloud Foundry buildpack 实现过程中建立起来的。 这意味着您可以使用云端基金会来扩充。 构建包确保你的系统自动开始作为集群运行。

Kubernetes也支持集群，但您必须使用 *Statelfull Set*。 在
个关于如何在 Kubernetes 上运行 Mendix 的 *的</a> 部分有更多关于这个问题的信息* 中。</p> 



## 3 集群基础设施

Mendix 运行时集群需要以下基础设施：

![](attachments/16714073/16844074.png)

这意味着Mendix 集群需要负载均衡器来将客户端的负载分配到可用的 Runtime 集群节点。 这也意味着所有节点都需要连接到同一个Mendix 数据库。 文件需要存储在 S3 上(详情请参阅下面的 [文件存储](#file-storage) 部分)。 您的集群中的节点数量取决于应用程序、 高可用性要求及其使用情况。



## 4 组队长 & 组队员

Mendix Runtime 有一个集群领先的概念。 这是Mendix Runtime 集群中的一个单一节点，执行集群管理活动。 这些活动是：

* **会话清理处理** - 每个节点过期其会话(意思, 未用于配置的时间窗框，群集领导删除数据库中持续存在的会话 
      * 在特殊情况下（例如，节点崩溃），某些会话可能无法从数据库中删除。 在这种情况下，群组领导人确保此移除仍在进行
* **集群节点过期处理** - 在集群节点过期后移除其过期的集群节点(意指，在配置的时间段内不给心打)
* **背景作业过期处理** - 在信息过期后移除背景作业的数据 (指，超过特定时间)
* **解除屏蔽的用户**
* **执行预定事件** - 预定事件只在集群头上执行
* **在新部署后执行数据库同步**
* **在新部署后清除持续会话** - 使所有现有会话无效，以便与最新的模型版本同步

这些活动只由分组领导人进行。 如果群组领导人未运行，群组仍将继续运行。 不过，上述活动将不予执行。

Cloud Foundry Buildpack 决定哪个集群节点成为集群领先并成为集群奴隶。



## 5 Cluster Startup

集群中的个别节点可以启动和停止，但对应用程序的运行时间没有影响。 然而，当您部署一个新版本的应用时，整个集群将重新启动，群集领导决定是否需要数据库同步。 这意味着应用程序部署时会出现一些故障。

如果需要数据库同步，所有分组奴隶都将等待集群领导人完成数据库同步工作。 当数据库同步完成后，所有集群节点将完全运行。

如果不需要数据库同步，所有集群节点将在启动后立即完全运行。



## 6 个文件存储 {#file-storage}

上传的文件应该存储在共享的文件存储设施中，因为每个Mendix Runtime 节点都应该访问相同的文件。 要么共享本地存储设施，要么将文件存储在中央存储设施中，例如Amazon S3文件存储， Microsoft Azure Blob storage 或 IBM Bluemix Object Storage 

关于配置Mendix Runtime 以存储这些存储设备上的文件的更多信息，请参阅 [Runtime Customization](custom-settings)。



## 7 启动后 & 关闭前置微流 {#startup-shutdown-microflows}

可以在Mendix中配置 `后启动` and `前导关机` 微流。 在Mendix 集群中，这意味着这些微流被调用到每个节点。 这可以让您注册请求处理程序和其他活动。 然而，在这些微流过程中维护数据库受到强烈阻挠，因为它可能会影响到同一组群的其他节点。 集群启动或关闭时无法运行微流。



## 8 集群限制



### 8.1 微流程调试

在运行多节点集群时，您无法预测将执行微流程的节点。 因此，无法在 Mendix Studio Pro的集群中调试这种微流程。 然而，您仍然可以在运行 Mendix Runtime 的单个实例时调试微流。



### 8.2 集群锁定(有保障的单一执行)

某些应用需要在某个时间点单次执行某项活动。 在单个节点Mendix Runtime中，可以使用 JVM 锁来保证这一点。 然而，在分布的情况下，这些JVM使用不同的机器运行，因此没有可用的锁系统。 Mendix 也不支持集群锁定。 如果不能避免这种情况，你可能需要使用外部分布式锁管理器。 然而，牢记在分布式系统中锁定是复杂的，容易失败（例如，由于锁定饥饿或锁定过期）。

{{% alert type="info" %}}

由于上述原因，微流程的 **禁止并行执行** 属性仅适用于单个节点。 

{{% /报警 %}}



## 9 集群中的肮脏状态

当用户登录到Mendix 应用程序并开始通过特定的应用程序流程时， 系统可以暂时保留某些数据，同时不将其保留在数据库中。 数据保存在Mendix 客户端内存中，并代表用户传送到 Mendix Runtime 节点。

例如，请想象您正在通过Mendix 应用程序预定一个假期，带有航班、旅馆和出租车。 在第一步，您选择并配置这个航班，第二步是您的酒店， 在你的第三辆出租车中，在最后一步，你确认预订和付款。 每个步骤都可以在不同的屏幕上，但当你从第一步转到第二步时。 你仍然想记住你预订的航班。 这叫做“肮脏状态”。 数据尚未最后确定，但应在不同请求之间保留。 因为必须可靠地缩小规模并支持失败的假设情景， 状态不能存储在请求之间的 Mendix Runtime 节点的内存。 因此，该州被退回给打电话者(Mendix 客户)，并被添加到其后的请求中。 这样每个节点就可以在这些请求中使用该状态。

下面的图像描述了这种行为：

![](attachments/16714073/16844072.png)

从Mendix 数据库中读取对象并删除(未更改的)对象仍然是一个“清理状态”。 更改一个现有对象或实例化一个新对象将创建"脏状态"。 Dirty 状态需要从Mendix 客户端发送到Mendix Runtime以及每个请求。 提交对象或回滚将从肮脏状态中移除。 如果一个实例化或更改对象被删除，也会发生同样的情况。 不可持续的实体总是肮脏状态的一部分。

只有来自 Mendix 客户端的请求(同步和异步调用)的肮脏状态才能保留在请求之间。 对于所有其他请求——例如预定的事件、网络服务或背景执行——国家只能用于当前请求。 此后，肮脏的状态要么必须持续下去，要么被抛弃。 仅允许 Mendix 客户端请求保留其肮脏状态的原因是，这是当前唯一能够使用实际用户输入的频道。 用户输入要求在请求之间对数据有更多的互动和灵活性。 只允许这些请求保留其肮脏状态， Mendix Runtime 和外部源上的负载被最小化，性能被优化。

{{% alert type="info" %}}
Whenever the Mendix Client is restarted, all the state is discarded, as it is only kept in the Mendix Client memory. 当重新加载浏览器标签时Mendix 客户端会重启(例如，) 按下 <kbd>F5</kbd>), 重新启动移动混合应用或明确退出。
{{% /报警 %}}

属于肮脏状态的对象越多， Mendix Runtime 和 Mendix 客户端之间的请求和响应必须传输更多数据。 因此，这对业绩产生影响。 在集群环境中，建议尽量减少肮脏状态的程度，以尽量减少同步对业绩的影响。

Mendix 客户端仅通过发送处理请求时可能读取的数据来优化发送给Mendix Runtime的状态数量。 例如， 如果您调用了一个微流程，它获取 `预订` 作为参数和检索 `飞行在关联上` 然后客户端将只会传递 `预订` 和关联的 `飞行`s来自肮脏状态以及请求。 但不是 `酒店`s。 请注意，这种行为是最好的努力； 如果微流过于复杂，不能分析 (例如) 当一个 Java 动作以状态对象作为参数被调用时，整个肮脏状态将会被发送。 可以通过 [优化网络调用](project-settings#optimize-network-calls) 项目设置禁用此优化。

{{% alert type="warning" %}}

必须认识到，当使用 Mendix 的外部网络服务来获取外部数据时。 这些行动的反应被转换成Mendix 实体。 只要Mendix 数据库中不存在这种武器， 它们将是肮脏状态的一部分，对申请的执行产生不利影响。 为了减少这种影响，这种行为今后可能会改变。 

{{% /报警 %}}

减少大量请求和答复对业绩的影响， 一个应用开发者应该知道引起大量请求和响应的以下场景：

* 创建大量不可持续实体并在页面中显示它们的微流
* 微流调用网络服务来检索外部数据并将其转换为不可持续的实体
* 一个包含多个微流数据源数据视图的页面。每个页面都会导致状态传输到 Mendix Runtime 来处理微流

{{% alert type="warning" %}}

为了确保在您的应用中适用上述情景时，肮脏状态不会变得太大， 它建议当对象不再需要时明确删除它们，这样它们就不再是状态的一部分。 这将释放Mendix Runtime 节点的内存以处理请求并提高性能。 

{{% /报警 %}}



## 10 个实体与 `System.Session` 或 `System.User`

`$currentSession` *会话* 对象可在微流中使用，所以可以轻松获取当前会话的引用。 当一个对象需要存储时，其关联可以设置为 `$currentSession`， 和当对象需要再次检索时 `$currentSession` 可以用作起点，从中获取所需的对象可以通过关联获取。 相关对象的设计能够满足人们的需要。 此模式适用于与 `System.User` 相关的实体。 在这种情况下，您可以使用 `$currentUser` *用户* 对象。

![](attachments/core/2018-03-01_17-49-15.png)

例如， 您可以将 `密钥` 和 `值` 成员添加到一个 `数据` 实体与 `系统相关联。 会话` (并有关键值的常量)。

![](attachments/core/2018-03-01_17-42-38.png)

`值` 可以很容易地通过在 `密钥上查找` 的值 `数据` 实例列表中的值。

![](attachments/core/2018-03-01_17-56-37.png)

{{% alert type="warning" %}}

当数据与当前用户或当前会话相关时，它不能自动收集。 因此，这种数据将随每次请求一起发送到服务器，然后根据这些请求的答复退回。 因此，在无法保留这种临时数据的情况下，应将实体实例与当前用户和本届会议联系起来。 

{{% /报警 %}}



## 11 次会话总是持久性的

为了支持无缝集群，会话总是在数据库中持续存在。 在以前的版本中，这是一个众所周知的性能瓶颈。 Mendix 现在包含优化以缓存此性能。

为此目的对数据库进行的回程访问会因为给持续会话最多30秒缓存时间（默认情况下）而减少。 这意味着会议结束后仍可在群集的其他节点上进入三十秒钟。 但只有在节点在退出之前处理了此次会话上的请求的情况下。 此超时可以配置。 降低它使集群更安全，因为在配置的时间窗口内会议仍然可以访问的机会较小。 然而，这也需要更经常地走访数据库（这影响到业绩）。 增加超时效果相反。 可以通过设置 `会期验证超时` (以毫秒为单位的值) 来配置它。

持续会话还会在每次请求时存储最后活跃的日期。 改进业绩的这一特定方面； 会话的最后活跃日期属性不再在每个请求下立即承诺到数据库。 与此相反，这个信息已排队，将在一个可配置的间隔下运行，存储在 Mendix 数据库中。 此操作可以验证会话是否被另一个节点注销，以及最后一个活动日期是否比数据库中的日期更近。 可以通过设置 `ClusterManagerActionInterval` (以毫秒为单位的值) 来配置间隔。

{{% alert type="warning" %}}

覆盖 `SessionTimeout` 和 `ClusterManagerActionInterval` 的默认值可能会影响“保持活着”的行为并导致意外的会话注销. 最佳做法是将 `ClusterManagerActionInterval` 设置为 `SessionTimeout 的` 的一半，以便每个节点有机会在会话间隔期间至少运行一次清理行动。 

{{% /报警 %}}

